<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Navigation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Ensure canvas perfectly overlaps the image */
      .video-container {
        position: relative;
        display: inline-block;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      #camera-stream {
        display: block;
        width: 640px; /* Base width */
        height: auto;
      }

      #ai-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Let clicks pass through to video if needed */
      }
    </style>
  </head>
  <body class="bg-slate-900 text-white p-10 font-sans">
    <div class="max-w-4xl mx-auto">
      <header class="mb-6 flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-blue-400">NavBot Dashboard</h1>
          <p class="text-slate-400">Live feed with YOLOv8 Object Detection</p>
        </div>
        <div
          id="status"
          class="px-3 py-1 rounded bg-red-600 text-xs font-bold uppercase tracking-wide"
        >
          AI Disconnected
        </div>
      </header>

      <!-- The Main Viewport -->
      <div class="video-container border-2 border-slate-700">
        <!-- 1. The Raw Stream from Pi -->
        <img
          id="camera-stream"
          src="http://172.20.10.10:8080/?action=stream"
          alt="Waiting for stream..."
        />

        <!-- 2. The Transparent AI Drawing Layer -->
        <canvas id="ai-layer"></canvas>
      </div>

      <!-- Live Logs -->
      <div class="mt-6 grid grid-cols-2 gap-4">
        <div class="bg-slate-800 p-4 rounded border border-slate-700">
          <h3 class="font-bold text-slate-300 mb-2">Detected Objects</h3>
          <ul
            id="object-list"
            class="text-sm space-y-1 text-green-400 font-mono h-32 overflow-y-auto"
          >
            <!-- Items added via JS -->
          </ul>
        </div>

        <div class="bg-slate-800 p-4 rounded border border-slate-700">
          <h3 class="font-bold text-slate-300 mb-2">System Status</h3>
          <p class="text-sm text-slate-400">
            Processing Node: <span class="text-white">Laptop (Localhost)</span>
          </p>
          <p class="text-sm text-slate-400">
            Model: <span class="text-white">YOLOv8 Nano</span>
          </p>
          <p class="text-sm text-slate-400">
            Latency: <span id="ping" class="text-white">--</span> ms
          </p>
          <p class="text-sm text-slate-400">
            Inference: <span id="infer" class="text-white">--</span> ms
          </p>
          <p class="text-sm text-slate-400">
            Skip: <span id="skip" class="text-white">--</span>
          </p>
          <p class="text-sm text-slate-400">
            Frame: <span id="frame-size" class="text-white">--</span>
          </p>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("ai-layer");
      const ctx = canvas.getContext("2d", { alpha: true, willReadFrequently: false });
      const img = document.getElementById("camera-stream");
      const statusBadge = document.getElementById("status");
      const objectList = document.getElementById("object-list");
      const inferEl = document.getElementById("infer");
      const skipEl = document.getElementById("skip");
      const frameSizeEl = document.getElementById("frame-size");

      // Connect to Python Server on Laptop
      // WebSocket with auto-reconnect and latency measurement
      let ws = null;
      let latestData = null;
      let reconnectDelayMs = 1000; // backoff cap 10s

      function connectWS() {
        ws = new WebSocket("ws://localhost:8765");

        ws.onopen = () => {
          statusBadge.innerText = "AI Connected";
          statusBadge.className =
            "px-3 py-1 rounded bg-green-500 text-xs font-bold uppercase tracking-wide";
          reconnectDelayMs = 1000; // reset backoff
          console.log("Connected to AI Server");
        };

        ws.onclose = () => {
          statusBadge.innerText = "AI Offline (reconnecting...)";
          statusBadge.className =
            "px-3 py-1 rounded bg-yellow-500 text-xs font-bold uppercase tracking-wide";
          setTimeout(connectWS, reconnectDelayMs);
          reconnectDelayMs = Math.min(reconnectDelayMs * 2, 10000);
        };

        ws.onmessage = (event) => {
          latestData = JSON.parse(event.data);
        };
      }
      connectWS();

      function draw() {
        // Match canvas to displayed image size if changed
        const w = img.clientWidth;
        const h = img.clientHeight;
        if (canvas.width !== w || canvas.height !== h) {
          canvas.width = w;
          canvas.height = h;
        }

        if (latestData) {
          const objects = latestData.objects || [];
          const inferMs = latestData.infer_ms;
          const skipVal = latestData.skip;
          const fw = latestData.width;
          const fh = latestData.height;
          const serverTs = latestData.timestamp; // seconds
          if (serverTs) {
            const nowSec = Date.now() / 1000;
            const oneWayMs = Math.max(0, Math.round((nowSec - serverTs) * 1000));
            const pingEl = document.getElementById("ping");
            if (pingEl) pingEl.textContent = oneWayMs;
          }

          // Update metrics with minimal DOM churn
          if (inferMs !== undefined) inferEl.textContent = inferMs;
          if (skipVal !== undefined) skipEl.textContent = skipVal;
          if (fw && fh) frameSizeEl.textContent = `${fw}x${fh}`;

          // Clear and draw
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.strokeStyle = "#00ff00";
          ctx.lineWidth = 2;
          ctx.font = "bold 12px Arial";

          // Rebuild object list efficiently
          objectList.textContent = "";

          for (let i = 0; i < objects.length; i++) {
            const obj = objects[i];
            const [nx1, ny1, nx2, ny2] = obj.bbox;
            const x = nx1 * canvas.width;
            const y = ny1 * canvas.height;
            const wpx = (nx2 - nx1) * canvas.width;
            const hpx = (ny2 - ny1) * canvas.height;

            ctx.strokeRect(x, y, wpx, hpx);
            const labelText = `${obj.label} ${Math.round((obj.conf || 0) * 100)}%`;
            const labelWidth = ctx.measureText(labelText).width + 10;
            const labelHeight = 18;
            const labelY = Math.max(0, y - labelHeight);

            ctx.fillStyle = "#00ff00";
            ctx.fillRect(x, labelY, labelWidth, labelHeight);
            ctx.fillStyle = "#000000";
            ctx.fillText(labelText, x + 5, labelY + labelHeight - 5);

            const li = document.createElement("li");
            li.textContent = `> ${obj.label} detected`;
            objectList.appendChild(li);
          }
        }

        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);
    </script>
  </body>
</html>
  